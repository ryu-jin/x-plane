------------------------------------------------------
- Sync Saitek Trim Wheel Whe AP is engaged in IXEG 737
------------------------------------------------------
- Specify your Saitek Wheel ID here
-----------------------------------
local trim_wheel_id  = 0
------------------------
--local file = io.open("trim.txt", "w")
local not_synced = 0
local ap_engaged = 0
local sound_time = 0
local play_trim_up = 1
local play_trim_down = 1
dataref("xp_elv_trim", "sim/flightmodel/controls/elv_trim", "writable")
dataref("trim_wheel", "sim/joystick/joystick_axis_values", "readonly", trim_wheel_id)
local autopilot_mode = dataref_table("sim/cockpit/autopilot/autopilot_mode") -- autopilot mode (0 = off / 1 = fd / 2 = ap) 
dataref("autopilot_A", "ixeg/733/MCP/mcp_a_comm_ann", "readonly")
dataref("autopilot_B", "ixeg/733/MCP/mcp_b_comm_ann", "readonly")
local trim_wheel_delta = 1.0/1024.0
xp_elv_trim_delta = 1/473

local trimvals =  { ["0.51319"] = -1.00000,
["0.51417"] = -1.000000,
["0.51515"] = -1.000000,
["0.51612"] = -1.000000,
["0.51808"] = -1.000000,
["0.52101"] = -1.000000,
["0.52492"] = -1.000000,
["0.52981"] = -1.000000,
["0.53372"] = -1.000000,
["0.53567"] = -1.000000,
["0.53665"] = -1.000000,
["0.53861"] = -0.270007,
["0.53861"] = -0.995764,
["0.53958"] = -0.270007,
["0.53958"] = -0.991545,
["0.54056"] = -0.987310,
["0.54154"] = -0.983081,
["0.54252"] = -0.978856,
["0.54447"] = -0.970392,
["0.54545"] = -0.270007,
["0.54545"] = -0.966173,
["0.54740"] = -0.270007,
["0.54740"] = -0.957719,
["0.54838"] = -0.270007,
["0.54838"] = -0.953480,
["0.55034"] = -0.945036,
["0.55131"] = -0.940801,
["0.55229"] = -0.936572,
["0.55425"] = -0.270007,
["0.55425"] = -0.928118,
["0.55620"] = -0.919664,
["0.55718"] = -0.915439,
["0.56011"] = -0.902746,
["0.56304"] = -0.890067,
["0.56598"] = -0.877374,
["0.56891"] = -0.864695,
["0.57184"] = -0.852002,
["0.57575"] = -0.835094,
["0.57966"] = -0.818186,
["0.58357"] = -0.801269,
["0.58748"] = -0.784351,
["0.59237"] = -0.763214,
["0.59628"] = -0.746292,
["0.59824"] = -0.737848,
["0.60019"] = -0.270007,
["0.60019"] = -0.729384,
["0.60117"] = -0.725155,
["0.60215"] = -0.720920,
["0.60410"] = -0.712476,
["0.60703"] = -0.699787,
["0.60997"] = -0.687104,
["0.61290"] = -0.270007,
["0.61290"] = -0.674411,
["0.61485"] = -0.665967,
["0.61583"] = -0.661738,
["0.61779"] = -0.653278,
["0.61876"] = -0.649049,
["0.62170"] = -0.636360,
["0.62463"] = -0.623677,
["0.62854"] = -0.606769,
["0.63049"] = -0.270007,
["0.63049"] = -0.598301,
["0.63245"] = -0.589851,
["0.63343"] = -0.585622,
["0.63538"] = -0.577168,
["0.63636"] = -0.572933,
["0.63831"] = -0.564486,
["0.64027"] = -0.556026,
["0.64222"] = -0.547568,
["0.64516"] = -0.534889,
["0.64809"] = -0.522190,
["0.65102"] = -0.509517,
["0.65298"] = -0.501059,
["0.65395"] = -0.270007,
["0.65395"] = -0.496824,
["0.65493"] = -0.492599,
["0.65591"] = -0.488370,
["0.65689"] = -0.270007,
["0.65689"] = -0.484145,
["0.65884"] = -0.475687,
["0.65982"] = -0.471458,
["0.66177"] = -0.463004,
["0.66275"] = -0.458779,
["0.66471"] = -0.450315,
["0.66764"] = -0.437632,
["0.66862"] = -0.433407,
["0.67057"] = -0.270007,
["0.67057"] = -0.424943,
["0.67155"] = -0.270007,
["0.67155"] = -0.420714,
["0.67253"] = -0.416485,
["0.67350"] = -0.412260,
["0.67448"] = -0.408031,
["0.67644"] = -0.399577,
["0.67741"] = -0.395342,
["0.67937"] = -0.386898,
["0.68230"] = -0.374205,
["0.68328"] = -0.369970,
["0.68621"] = -0.357297,
["0.68914"] = -0.344608,
["0.69110"] = -0.336150,
["0.69208"] = -0.331925,
["0.69403"] = -0.270007,
["0.69403"] = -0.323462,
["0.69501"] = -0.270007,
["0.69501"] = -0.319233,
["0.69696"] = -0.310789,
["0.69794"] = -0.270007,
["0.69794"] = -0.306554,
["0.69990"] = -0.298090,
["0.70087"] = -0.270007,
["0.70087"] = -0.293861,
["0.70185"] = -0.289636,
["0.70283"] = -0.285417,
["0.70381"] = -0.270007,
["0.70381"] = -0.281182,
["0.70576"] = -0.270007,
["0.70576"] = -0.272728,
["0.70674"] = -0.268499,
["0.70869"] = -0.260045,
["0.70967"] = -0.255810,
["0.71065"] = -0.251581,
["0.71163"] = -0.247352,
["0.71260"] = -0.243127,
["0.71358"] = -0.238898,
["0.71456"] = -0.234673,
["0.71554"] = -0.230444,
["0.71749"] = -0.221980,
["0.71847"] = -0.217755,
["0.72043"] = -0.209307,
["0.72140"] = -0.205072,
["0.72336"] = -0.196614,
["0.72629"] = -0.183935,
["0.72825"] = -0.175471,
["0.73020"] = -0.167017,
["0.73216"] = -0.158563,
["0.73313"] = -0.154334,
["0.73509"] = -0.145870,
["0.73607"] = -0.141645,
["0.73704"] = -0.137416,
["0.73900"] = -0.128962,
["0.74095"] = -0.120508,
["0.74291"] = -0.112044,
["0.74486"] = -0.103590,
["0.74780"] = -0.090907,
["0.75073"] = -0.078228,
["0.75366"] = -0.065536,
["0.75464"] = -0.061301,
["0.75562"] = -0.057082,
["0.75659"] = -0.052857,
["0.75855"] = -0.044393,
["0.76148"] = -0.031710,
["0.76344"] = -0.023256,
["0.76539"] = -0.014792,
["0.76832"] = -0.002119,
["0.77126"] = 0.010571,
["0.77419"] = 0.023256,
["0.77712"] = 0.035941,
["0.77810"] = 0.040169,
["0.77908"] = 0.044398,
["0.78005"] = 0.048626,
["0.78201"] = 0.057083,
["0.78299"] = 0.061311,
["0.78494"] = 0.069768,
["0.78592"] = 0.073996,
["0.78885"] = 0.086681,
["0.79178"] = 0.099366,
["0.79374"] = 0.107823,
["0.79667"] = 0.120508,
["0.80058"] = 0.137421,
["0.80351"] = 0.150106,
["0.80645"] = 0.162791,
["0.80840"] = 0.171248,
["0.80938"] = 0.175476,
["0.81133"] = 0.183933,
["0.81231"] = 0.188161,
["0.81524"] = 0.200846,
["0.81818"] = 0.213531,
["0.82111"] = 0.226216,
["0.82404"] = 0.238901,
["0.82697"] = 0.251586,
["0.82893"] = 0.260042,
["0.82991"] = 0.264271,
["0.83284"] = 0.276956,
["0.83773"] = 0.298097,
["0.84066"] = 0.310782,
["0.84457"] = 0.327696,
["0.84750"] = 0.340381,
["0.84946"] = 0.348837,
["0.85043"] = 0.353066,
["0.85141"] = 0.357294,
["0.85337"] = 0.365751,
["0.85630"] = 0.378436,
["0.85923"] = 0.391121,
["0.86119"] = 0.399577,
["0.86412"] = 0.412262,
["0.86705"] = 0.424947,
["0.87096"] = 0.441860,
["0.87292"] = 0.450317,
["0.87390"] = 0.454545,
["0.87585"] = 0.463002,
["0.87683"] = 0.467230,
["0.87878"] = 0.475687,
["0.87976"] = 0.479915,
["0.88269"] = 0.492600,
["0.88465"] = 0.501057,
["0.88758"] = 0.513742,
["0.89051"] = 0.526427,
["0.89345"] = 0.539112,
["0.89736"] = 0.556025,
["0.90029"] = 0.568710,
["0.90322"] = 0.581395,
["0.90615"] = 0.594080,
["0.90811"] = 0.602537,
["0.90909"] = 0.606765,
["0.91104"] = 0.615222,
["0.91202"] = 0.619450,
["0.91495"] = 0.632135,
["0.91788"] = 0.644820,
["0.92473"] = 0.674418,
["0.92961"] = 0.695560,
["0.93059"] = 0.699788,
["0.93255"] = 0.708245,
["0.93548"] = 0.720930,
["0.93841"] = 0.733615,
["0.94134"] = 0.746300,
["0.94428"] = 0.758985,
["0.94721"] = 0.771670,
["0.95307"] = 0.797040,
["0.95601"] = 0.809725,
["0.96187"] = 0.835095,
["0.96676"] = 0.856236,
["0.97262"] = 0.881606,
["0.97556"] = 0.894291,
["0.97653"] = 0.898520,
["0.97751"] = 0.902748,
["0.97849"] = 0.906976,
["0.97947"] = 0.911205,
["0.98044"] = 0.915433,
["0.98240"] = 0.923890,
["0.98533"] = 0.930000,
["0.98533"] = 0.936575,
["0.98729"] = 0.930000,
["0.98729"] = 0.945031,
["0.98826"] = 0.930000,
["0.98826"] = 0.949260,
["0.99022"] = 0.930000,
["0.99022"] = 0.957716,
["0.99120"] = 0.930000,
["0.99120"] = 0.961945,
["0.99315"] = 0.970401,
["0.99413"] = 0.930000,
["0.99413"] = 0.974630,
["0.99706"] = 0.930000,
["0.99706"] = 0.987315,
["0.99902"] = 0.995771,
["1.00000"] = 0.930000
}

function setContains(set, key)
    return set[key] ~= nil
end

function disable_trim_wheel()
	set_axis_assignment( trim_wheel_id, "none", "normal" )
end

function enable_trim_wheel()
	set_axis_assignment( trim_wheel_id, "elev trim", "normal" )
end

function save_wheel_values()
	draw_string(20,800 + (100 * xp_elv_trim), xp_elv_trim, "green")  
	draw_string(232,800 + (100 * xp_elv_trim), trim_wheel, "red")
	file:write(string.format("[\"%.10f\"] = %.10f,\n", trim_wheel, xp_elv_trim)) 
	if xp_elv_trim == -1 then
		file:close()
	end
end

function sync_trim()
	s_trim_wheel = string.format("%.5f", trim_wheel)
	
	if (autopilot_A == 1 or autopilot_B == 1) then
		disable_trim_wheel()
		ap_engaged = 1
		not_synced = 1
	else
		ap_engaged = 0
	end

	if (not_synced == 1 and ap_engaged == 0) then
		--draw_string(20,800 + (100 * xp_elv_trim), xp_elv_trim, "green")  
		--draw_string(232,800 + (100 * xp_elv_trim), trim_wheel, "red")  
		--draw_string(432,800 + (100 * xp_elv_trim), autopilot_A, "yellow")
		--draw_string(632,800 + (100 * xp_elv_trim), autopilot_B, "yellow")
		if setContains(trimvals, s_trim_wheel) then
			if string.format("%.1f", trimvals[s_trim_wheel]) == string.format("%.1f", xp_elv_trim) then
				--draw_string(832,800 + (100 * xp_elv_trim), "synced", "green")
				trim_sound = load_WAV_file("Resources/plugins/FlyWithLua/sounds/synchronized.wav")
				play_sound(trim_sound)
				not_synced = 0
				enable_trim_wheel()
				play_trim_up = 1
				play_trim_down = 1
			else
				--draw_string(832,800 + (100 * xp_elv_trim), trimvals[s_trim_wheel], "red")
				if xp_elv_trim > trimvals[s_trim_wheel] then
					if os.clock() > sound_time then
					--if play_trim_up == 1 then
						trim_sound = load_WAV_file("Resources/plugins/FlyWithLua/sounds/trimup.wav")
				  		play_sound(trim_sound)
						play_trim_up = 0
						sound_time = os.clock() + 5
					end
				else
					if os.clock() > sound_time then
					--if play_trim_down == 1 then
						trim_sound = load_WAV_file("Resources/plugins/FlyWithLua/sounds/trimdown.wav")
				  		play_sound(trim_sound)
						play_trim_down = 0
						sound_time = os.clock() + 5
					end
				end
			end
		else
			draw_string(832,800 + (100 * xp_elv_trim), "nil", "red")
		end
	end
end

enable_trim_wheel()
do_every_draw("sync_trim()")
--do_every_draw("save_wheel_values()")
